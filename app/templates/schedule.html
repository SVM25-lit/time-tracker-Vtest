<script>
document.addEventListener('DOMContentLoaded', function() {
    const scheduleBody = document.getElementById('scheduleBody');
    const weekPicker = document.getElementById('weekPicker');
    const currentWeekBtn = document.getElementById('currentWeekBtn');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const copyWeekBtn = document.getElementById('copyWeekBtn');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const colorPicker = document.getElementById('colorPicker');
    const categorySelect = document.getElementById('categorySelect');
    
    // Конфигурация времени
    const START_HOUR = 4;
    const END_HOUR = 22.5; // 22:30
    const TIME_SLOT_MINUTES = 15;
    
    let categories = [];
    let events = [];
    
    // Инициализация
    initSchedule();
    loadCategories();
    loadEvents();
    initColorPicker();
    initTimeSelects();
    initModalDates();
    
    // Функции
    
    function initSchedule() {
        scheduleBody.innerHTML = '';
        
        for (let hour = START_HOUR; hour < END_HOUR; hour += 0.25) {
            const hourInt = Math.floor(hour);
            const minute = (hour - hourInt) * 60;
            
            const timeString = `${hourInt.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const isHourMark = minute === 0;
            
            const row = document.createElement('tr');
            
            if (isHourMark) {
                row.classList.add('hour-marker');
            }
            
            // Проверка текущего времени
            const now = new Date();
            const currentHour = now.getHours() + now.getMinutes() / 60;
            if (Math.abs(currentHour - hour) < 0.125) {
                row.classList.add('current-time');
            }
            
            // Колонка времени
            const timeCell = document.createElement('td');
            timeCell.className = 'time-column';
            timeCell.textContent = timeString;
            row.appendChild(timeCell);
            
            // Колонки для каждого дня
            for (let i = 0; i < 7; i++) {
                const planCell = document.createElement('td');
                planCell.className = 'plan-cell';
                planCell.dataset.time = timeString;
                planCell.dataset.day = i;
                planCell.dataset.type = 'plan';
                planCell.addEventListener('click', handleCellClick);
                
                const factCell = document.createElement('td');
                factCell.className = 'fact-cell';
                factCell.dataset.time = timeString;
                factCell.dataset.day = i;
                factCell.dataset.type = 'fact';
                factCell.addEventListener('click', handleCellClick);
                
                const dayCell = document.createElement('td');
                dayCell.className = 'day-column';
                dayCell.appendChild(planCell);
                dayCell.appendChild(factCell);
                
                row.appendChild(dayCell);
            }
            
            scheduleBody.appendChild(row);
        }
    }
    
    function handleCellClick(event) {
        const cell = event.currentTarget;
        const time = cell.dataset.time;
        const day = parseInt(cell.dataset.day);
        const type = cell.dataset.type;
        
        // Получаем дату из выбранной недели
        const [year, week] = weekPicker.value.split('-W');
        const date = getDateFromWeek(year, week, day);
        
        // Показываем модальное окно с предзаполненными данными
        const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
        
        // Устанавливаем тип события
        if (type === 'plan') {
            document.getElementById('typePlan').checked = true;
        } else {
            document.getElementById('typeFact').checked = true;
        }
        
        // Устанавливаем даты
        document.getElementById('startDate').value = date;
        document.getElementById('endDate').value = date;
        
        // Устанавливаем время
        document.getElementById('startTime').value = time;
        
        // Рассчитываем время окончания (+1 час по умолчанию)
        const [hours, minutes] = time.split(':').map(Number);
        let endHour = hours + 1;
        if (endHour >= END_HOUR) endHour = END_HOUR - 0.25;
        const endTime = `${endHour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        document.getElementById('endTime').value = endTime;
        
        modal.show();
    }
    
    function getDateFromWeek(year, week, day) {
        // Исправленный расчет даты из номера недели
        const simple = new Date(year, 0, 1 + (week - 1) * 7 + day);
        const dow = simple.getDay();
        const ISOweekStart = simple;
        
        if (dow <= 4) {
            ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1 + day);
        } else {
            ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay() + day);
        }
        
        return ISOweekStart.toISOString().split('T')[0];
    }
    
    function loadCategories() {
        console.log('Загрузка категорий...');
        
        // Пробуем разные пути API
        const apiPaths = [
            '/api/v1/schedule/categories',
            '/api/v1/categories',
            '/api/my/stats'  // как fallback
        ];
        
        let requestIndex = 0;
        
        function tryNextPath() {
            if (requestIndex >= apiPaths.length) {
                console.log('Все пути API недоступны, используем тестовые данные');
                loadTestCategories();
                return;
            }
            
            const path = apiPaths[requestIndex];
            console.log(`Пробуем путь: ${path}`);
            
            fetch(path)
                .then(response => {
                    console.log(`Ответ от ${path}: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Данные категорий:', data);
                    
                    if (data.status === 'success' && data.categories) {
                        categories = data.categories;
                        updateCategorySelect();
                    } else if (data.categories) {
                        categories = data.categories;
                        updateCategorySelect();
                    } else if (data.user) {
                        // Если это ответ от /api/my/stats
                        loadTestCategories();
                    } else {
                        console.warn('Неожиданный формат данных:', data);
                        loadTestCategories();
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при запросе ${path}:`, error);
                    requestIndex++;
                    tryNextPath();
                });
        }
        
        tryNextPath();
    }
    
    function updateCategorySelect() {
        categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (category.color) {
                option.dataset.color = category.color;
            }
            categorySelect.appendChild(option);
        });
        
        console.log('Обновлен список категорий, количество:', categories.length);
    }
    
    function loadEvents() {
        console.log('Загрузка событий...');
        
        const [year, week] = weekPicker.value.split('-W');
        const apiPaths = [
            `/api/v1/schedule/week/${year}-W${week}`,
            `/api/v1/events/week/${year}-W${week}`,
            '/api/my/events'
        ];
        
        let requestIndex = 0;
        
        function tryNextPath() {
            if (requestIndex >= apiPaths.length) {
                console.log('Все пути API недоступны, используем тестовые события');
                loadTestEvents();
                return;
            }
            
            const path = apiPaths[requestIndex];
            console.log(`Загрузка событий по пути: ${path}`);
            
            fetch(path)
                .then(response => {
                    console.log(`Ответ событий от ${path}: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Данные событий:', data);
                    
                    if (data.status === 'success' && data.events) {
                        events = data.events;
                        renderEvents();
                        updateStatistics();
                    } else if (Array.isArray(data)) {
                        // Если API возвращает массив напрямую
                        events = data.map(event => ({
                            ...event,
                            category_name: event.category,
                            category_color: event.category_color
                        }));
                        renderEvents();
                        updateStatistics();
                    } else if (data.events) {
                        events = data.events;
                        renderEvents();
                        updateStatistics();
                    } else {
                        console.warn('Неожиданный формат данных событий:', data);
                        loadTestEvents();
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при загрузке событий из ${path}:`, error);
                    requestIndex++;
                    tryNextPath();
                });
        }
        
        tryNextPath();
    }
    
    function renderEvents() {
        console.log('Отрисовка событий, количество:', events.length);
        
        // Очищаем все события
        document.querySelectorAll('.plan-event, .fact-event').forEach(el => el.remove());
        
        if (events.length === 0) {
            console.log('Нет событий для отображения');
            return;
        }
        
        events.forEach((event, index) => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                
                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;
                
                const duration = (endHour - startHour) * 4; // В слотах по 15 минут
                const startSlot = Math.round((startHour - START_HOUR) * 4);
                
                if (startSlot < 0 || startSlot >= scheduleBody.children.length) {
                    console.warn(`Событие вне диапазона времени: ${startHour}:00`);
                    return;
                }
                
                // Получаем день недели (0=воскресенье, 1=понедельник...6=суббота)
                const dayOfWeek = start.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Приводим к 0-6 (пн=0...вс=6)
                
                const row = scheduleBody.children[startSlot];
                if (!row) {
                    console.warn(`Не найдена строка для слота ${startSlot}`);
                    return;
                }
                
                const cell = row.children[adjustedDay + 1]; // +1 для колонки времени
                if (!cell) {
                    console.warn(`Не найдена ячейка для дня ${adjustedDay}`);
                    return;
                }
                
                const targetCell = event.type === 'plan' ? 
                    cell.querySelector('.plan-cell') : 
                    cell.querySelector('.fact-cell');
                
                if (!targetCell) {
                    console.warn(`Не найдена целевая ячейка для типа ${event.type}`);
                    return;
                }
                
                const eventDiv = document.createElement('div');
                eventDiv.className = event.type === 'plan' ? 'plan-event' : 'fact-event';
                eventDiv.textContent = event.category_name || event.category?.name || 'Без категории';
                
                // Форматируем время для tooltip
                const startTimeStr = start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTimeStr = end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                eventDiv.title = `${event.category_name || 'Без категории'}\n${startTimeStr} - ${endTimeStr}`;
                
                // Цвет категории
                eventDiv.style.borderLeftColor = event.category_color || 
                                                event.category?.color || 
                                                (event.type === 'plan' ? '#198754' : '#0d6efd');
                
                if (duration > 1) {
                    eventDiv.style.height = `calc(${duration * 40}px - 2px)`;
                    eventDiv.style.position = 'absolute';
                    eventDiv.style.top = '0';
                    eventDiv.style.left = '2px';
                    eventDiv.style.right = '2px';
                    eventDiv.style.zIndex = '1';
                }
                
                targetCell.appendChild(eventDiv);
                console.log(`Событие ${index} добавлено: ${event.category_name} в ${startTimeStr}`);
                
            } catch (error) {
                console.error(`Ошибка при отрисовке события ${index}:`, error, event);
            }
        });
    }
    
    function updateStatistics() {
        let planHours = 0;
        let factHours = 0;
        let todayPlanHours = 0;
        let todayFactHours = 0;
        
        const today = new Date().toDateString();
        
        events.forEach(event => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                const duration = (end - start) / (1000 * 60 * 60); // Часы
                
                if (event.type === 'plan') {
                    planHours += duration;
                    if (start.toDateString() === today) {
                        todayPlanHours += duration;
                    }
                } else {
                    factHours += duration;
                    if (start.toDateString() === today) {
                        todayFactHours += duration;
                    }
                }
            } catch (error) {
                console.error('Ошибка при расчете статистики для события:', event, error);
            }
        });
        
        const todayPercentage = todayPlanHours > 0 ? 
            Math.round((todayFactHours / todayPlanHours) * 100) : 0;
        
        const weekPercentage = planHours > 0 ? 
            Math.round((factHours / planHours) * 100) : 0;
        
        document.getElementById('today-percentage').textContent = `${todayPercentage}%`;
        document.getElementById('week-percentage').textContent = `${weekPercentage}%`;
        document.getElementById('total-hours').textContent = `${Math.round(factHours)}ч`;
        
        console.log('Статистика обновлена:', { todayPercentage, weekPercentage, totalHours: Math.round(factHours) });
    }
    
    function initColorPicker() {
        const colors = [
            '#4361ee', '#3a0ca3', '#4cc9f0', '#7209b7', '#f72585',
            '#2a9d8f', '#e9c46a', '#f4a261', '#e76f51', '#264653',
            '#06d6a0', '#118ab2', '#ef476f', '#ffd166', '#8338ec'
        ];
        
        colors.forEach(color => {
            const colorDiv = document.createElement('div');
            colorDiv.className = 'color-option';
            colorDiv.style.width = '30px';
            colorDiv.style.height = '30px';
            colorDiv.style.backgroundColor = color;
            colorDiv.style.borderRadius = '50%';
            colorDiv.style.cursor = 'pointer';
            colorDiv.style.border = '2px solid transparent';
            colorDiv.dataset.color = color;
            
            colorDiv.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.style.borderColor = 'transparent';
                });
                this.style.borderColor = '#333';
                document.getElementById('selectedColor').value = color;
            });
            
            colorPicker.appendChild(colorDiv);
        });
        
        // Выбираем первый цвет по умолчанию
        if (colorPicker.firstChild) {
            colorPicker.firstChild.style.borderColor = '#333';
            document.getElementById('selectedColor').value = colors[0];
        }
    }
    
    function initTimeSelects() {
        const startTimeSelect = document.getElementById('startTime');
        const endTimeSelect = document.getElementById('endTime');
        
        startTimeSelect.innerHTML = '';
        endTimeSelect.innerHTML = '';
        
        const now = new Date();
        const currentTime = now.getHours() + now.getMinutes() / 60;
        let defaultStartTime = '';
        let defaultEndTime = '';
        
        for (let hour = START_HOUR; hour < END_HOUR; hour += 0.25) {
            const hourInt = Math.floor(hour);
            const minute = (hour - hourInt) * 60;
            const timeString = `${hourInt.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // Находим ближайшее время для дефолтных значений
            if (!defaultStartTime && hour >= currentTime - 0.5) {
                defaultStartTime = timeString;
                defaultEndTime = `${Math.min(hourInt + 1, Math.floor(END_HOUR)).toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }
            
            const option1 = document.createElement('option');
            option1.value = timeString;
            option1.textContent = timeString;
            if (timeString === defaultStartTime) option1.selected = true;
            startTimeSelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = timeString;
            option2.textContent = timeString;
            if (timeString === defaultEndTime) option2.selected = true;
            endTimeSelect.appendChild(option2);
        }
        
        // Если не нашли подходящее время, используем первое
        if (!defaultStartTime && startTimeSelect.options.length > 0) {
            startTimeSelect.options[0].selected = true;
            endTimeSelect.options[1]?.selected = true;
        }
    }
    
    function initModalDates() {
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        
        // Устанавливаем сегодняшнюю дату по умолчанию
        if (document.getElementById('startDate') && !document.getElementById('startDate').value) {
            document.getElementById('startDate').value = formattedDate;
        }
        if (document.getElementById('endDate') && !document.getElementById('endDate').value) {
            document.getElementById('endDate').value = formattedDate;
        }
    }
    
    // Тестовые данные
    function loadTestCategories() {
        console.log('Загрузка тестовых категорий');
        categories = [
            {id: 1, name: 'Работа', color: '#4361ee'},
            {id: 2, name: 'Учёба', color: '#4cc9f0'},
            {id: 3, name: 'Отдых', color: '#06d6a0'},
            {id: 4, name: 'Спорт', color: '#f72585'},
            {id: 5, name: 'Сон', color: '#7209b7'}
        ];
        updateCategorySelect();
    }
    
    function loadTestEvents() {
        console.log('Загрузка тестовых событий');
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        events = [
            {
                id: 1,
                category_id: 1,
                category_name: 'Работа',
                category_color: '#4361ee',
                type: 'plan',
                start_time: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T09:00:00`,
                end_time: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T12:00:00`,
                date: today.toISOString().split('T')[0]
            },
            {
                id: 2,
                category_id: 2,
                category_name: 'Учёба',
                category_color: '#4cc9f0',
                type: 'fact',
                start_time: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T14:00:00`,
                end_time: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}T16:00:00`,
                date: today.toISOString().split('T')[0]
            },
            {
                id: 3,
                category_id: 3,
                category_name: 'Отдых',
                category_color: '#06d6a0',
                type: 'plan',
                start_time: `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}T10:00:00`,
                end_time: `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}T12:00:00`,
                date: tomorrow.toISOString().split('T')[0]
            }
        ];
        
        renderEvents();
        updateStatistics();
    }
    
    // Обработчики событий
    
    weekPicker.addEventListener('change', function() {
        console.log('Неделя изменена:', weekPicker.value);
        loadEvents();
    });
    
    currentWeekBtn.addEventListener('click', function() {
        const today = new Date();
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        const currentWeek = `${today.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
        
        weekPicker.value = currentWeek;
        console.log('Переход к текущей неделе:', currentWeek);
        loadEvents();
    });
    
    prevWeekBtn.addEventListener('click', function() {
        const [year, week] = weekPicker.value.split('-W');
        let newWeek = parseInt(week) - 1;
        let newYear = parseInt(year);
        
        if (newWeek < 1) {
            newYear--;
            newWeek = 52;
        }
        
        weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        console.log('Предыдущая неделя:', weekPicker.value);
        loadEvents();
    });
    
    nextWeekBtn.addEventListener('click', function() {
        const [year, week] = weekPicker.value.split('-W');
        let newWeek = parseInt(week) + 1;
        let newYear = parseInt(year);
        
        if (newWeek > 52) {
            newYear++;
            newWeek = 1;
        }
        
        weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        console.log('Следующая неделя:', weekPicker.value);
        loadEvents();
    });
    
    copyWeekBtn.addEventListener('click', function() {
        if (confirm('Скопировать план текущей недели на следующую неделю?')) {
            console.log('Копирование недели:', weekPicker.value);
            
            // Пробуем разные пути API
            const apiPaths = ['/api/v1/schedule/copy', '/api/v1/copy-week'];
            
            function tryCopy(pathIndex) {
                if (pathIndex >= apiPaths.length) {
                    alert('API для копирования недоступно. Функция временно отключена.');
                    return;
                }
                
                fetch(apiPaths[pathIndex], {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_week: weekPicker.value
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert('Неделя успешно скопирована!');
                        if (data.target_week) {
                            weekPicker.value = data.target_week;
                            loadEvents();
                        }
                    } else {
                        alert('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при копировании (${apiPaths[pathIndex]}):`, error);
                    tryCopy(pathIndex + 1);
                });
            }
            
            tryCopy(0);
        }
    });
    
    addCategoryBtn.addEventListener('click', function() {
        console.log('Открытие модального окна создания категории');
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    });
    
    // Форма добавления категории
    document.getElementById('categoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Отправка формы категории');
        
        const categoryData = {
            name: document.getElementById('categoryName').value,
            color: document.getElementById('selectedColor').value,
            description: document.getElementById('categoryDescription').value
        };
        
        // Пробуем разные пути API
        const apiPaths = ['/categories', '/api/v1/schedule/categories'];
        
        function trySubmit(pathIndex) {
            if (pathIndex >= apiPaths.length) {
                alert('Не удалось создать категорию. API недоступно.');
                return;
            }
            
            const method = apiPaths[pathIndex] === '/categories' ? 'POST' : 'POST';
            
            fetch(apiPaths[pathIndex], {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(categoryData)
            })
            .then(response => {
                console.log('Ответ создания категории:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Данные создания категории:', data);
                
                if (data.status === 'success' || data.success) {
                    alert('Категория создана успешно!');
                    bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                    loadCategories();
                    
                    // Очистка формы
                    document.getElementById('categoryForm').reset();
                    // Восстанавливаем цвет по умолчанию
                    document.getElementById('selectedColor').value = '#4361ee';
                    if (colorPicker.firstChild) {
                        colorPicker.firstChild.style.borderColor = '#333';
                    }
                } else {
                    alert('Ошибка: ' + (data.message || data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error(`Ошибка при создании категории (${apiPaths[pathIndex]}):`, error);
                trySubmit(pathIndex + 1);
            });
        }
        
        trySubmit(0);
    });
    
    // Форма добавления события
    document.getElementById('addEventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Отправка формы события');
        
        // Проверяем, выбрана ли категория
        const categoryId = document.getElementById('categorySelect').value;
        if (!categoryId) {
            alert('Пожалуйста, выберите категорию');
            return;
        }
        
        // Форматируем дату и время
        const startDate = document.getElementById('startDate').value;
        const startTime = document.getElementById('startTime').value;
        const endDate = document.getElementById('endDate').value;
        const endTime = document.getElementById('endTime').value;
        
        if (!startDate || !startTime || !endDate || !endTime) {
            alert('Пожалуйста, заполните все поля даты и времени');
            return;
        }
        
        // Создаем объекты Date
        const startDateTime = new Date(`${startDate}T${startTime}:00`);
        const endDateTime = new Date(`${endDate}T${endTime}:00`);
        
        // Проверяем, что время окончания позже времени начала
        if (endDateTime <= startDateTime) {
            alert('Время окончания должно быть позже времени начала');
            return;
        }
        
        // Подготавливаем данные
        const eventData = {
            category_id: parseInt(categoryId),
            start_time: startDateTime.toISOString(),
            end_time: endDateTime.toISOString(),
            type: document.querySelector('input[name="eventType"]:checked').value,
            description: document.getElementById('eventDescription').value
        };
        
        console.log('Отправка данных события:', eventData);
        
        // Пробуем разные пути API
        const apiPaths = ['/api/v1/schedule/events', '/api/v1/events'];
        
        function trySubmit(pathIndex) {
            if (pathIndex >= apiPaths.length) {
                alert('Не удалось создать событие. API недоступно.');
                return;
            }
            
            fetch(apiPaths[pathIndex], {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventData)
            })
            .then(response => {
                console.log('Ответ создания события:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Данные создания события:', data);
                
                if (data.status === 'success') {
                    alert('Событие добавлено успешно!');
                    bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
                    loadEvents();
                    
                    // Очистка формы
                    document.getElementById('addEventForm').reset();
                    // Восстанавливаем значения по умолчанию
                    initModalDates();
                    initTimeSelects();
                    document.getElementById('typePlan').checked = true;
                } else {
                    alert('Ошибка: ' + (data.message || data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error(`Ошибка при создании события (${apiPaths[pathIndex]}):`, error);
                trySubmit(pathIndex + 1);
            });
        }
        
        trySubmit(0);
    });
    
    // Инициализация при загрузке
    console.log('Инициализация завершена');
    console.log('Текущая неделя из шаблона:', '{{ current_week }}');
    console.log('Дни из шаблона:', {{ days|tojson|safe }});
});
</script>
