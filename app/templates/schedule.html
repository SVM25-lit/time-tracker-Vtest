{% extends "base.html" %}

{% block title %}Расписание - Time Tracker{% endblock %}

{% block extra_css %}
<style>
    /* Основные изменения в layout */
    .main-content {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        margin-top: 20px;
    }
    
    .schedule-section {
        flex: 1;
        min-width: 0; /* Для корректной работы flex */
    }
    
    .right-sidebar {
        width: 350px;
        min-width: 350px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    /* Стили для таблицы расписания */
    .schedule-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        overflow-x: auto;
        width: 100%;
    }
    
    .schedule-header {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .schedule-table {
        min-width: 1000px;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .time-column {
        width: 80px;
        background-color: #f8f9fa;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
        vertical-align: top;
        padding: 0.5rem;
        border-right: 1px solid #dee2e6;
        position: sticky;
        left: 0;
        z-index: 50;
    }
    
    .day-column {
        width: 140px;
        vertical-align: top;
        border-right: 1px solid #dee2e6;
    }
    
    .day-header {
        background-color: #e9ecef;
        padding: 0.75rem;
        font-weight: 600;
        text-align: center;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 60px;
        z-index: 80;
    }
    
    .plan-header {
        background-color: #d1e7dd;
        color: #0f5132;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.9rem;
        border-bottom: 1px solid #badbcc;
    }
    
    .fact-header {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.9rem;
        border-bottom: 1px solid #bee5eb;
    }
    
    .time-slot {
        height: 40px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
    }
    
    .plan-cell, .fact-cell {
        height: 100%;
        padding: 2px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .plan-cell:hover {
        background-color: #e8f5e8;
    }
    
    .fact-cell:hover {
        background-color: #e8f5f5;
    }
    
    .plan-event, .fact-event {
        border-radius: 4px;
        padding: 3px 6px;
        margin: 1px;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        border-left: 3px solid;
    }
    
    .plan-event {
        background-color: rgba(25, 135, 84, 0.1);
        border-color: #198754;
    }
    
    .fact-event {
        background-color: rgba(13, 110, 253, 0.1);
        border-color: #0d6efd;
    }
    
    .current-time {
        background-color: rgba(255, 193, 7, 0.1);
        position: relative;
    }
    
    .current-time::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 2px;
        background-color: #ffc107;
        z-index: 10;
    }
    
    .hour-marker {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    /* Панель управления */
    .schedule-controls {
        background-color: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 1rem;
    }
    
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 0.5rem;
    }
    
    /* Категории - правая панель */
    .categories-panel {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .categories-list {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    
    .category-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 4px solid;
        transition: all 0.2s;
    }
    
    .category-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .category-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .category-info {
        flex: 1;
    }
    
    .category-name {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .category-time {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .add-category-btn {
        width: 100%;
        margin-top: 1rem;
    }
    
    /* График сравнения плана и факта */
    .comparison-chart {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-top: 0;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
        margin-top: 1rem;
    }
    
    .chart-bars {
        display: flex;
        align-items: flex-end;
        height: 200px;
        gap: 10px;
        margin-top: 40px;
        padding: 0 20px;
    }
    
    .chart-day {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .day-label {
        margin-top: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: center;
    }
    
    .bar-container {
        display: flex;
        gap: 4px;
        width: 100%;
        height: 100%;
    }
    
    .plan-bar {
        flex: 1;
        background: #d1e7dd;
        border-radius: 4px 4px 0 0;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .fact-bar {
        flex: 1;
        background: #d1ecf1;
        border-radius: 4px 4px 0 0;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .plan-bar:hover, .fact-bar:hover {
        opacity: 0.8;
        transform: scaleY(1.05);
    }
    
    .bar-value {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .legend-item-chart {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-color-chart {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    /* Быстрые действия */
    .quick-actions {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 1rem;
    }
    
    .action-btn {
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        cursor: pointer;
        text-align: center;
    }
    
    .action-btn:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .action-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
    }
    
    .action-text {
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    /* Адаптивность */
    @media (max-width: 1200px) {
        .main-content {
            flex-direction: column;
        }
        
        .right-sidebar {
            width: 100%;
            min-width: auto;
        }
        
        .schedule-container {
            min-width: 100%;
        }
    }
    
    @media (max-width: 768px) {
        .schedule-container {
            border-radius: 10px;
        }
        
        .schedule-controls {
            padding: 0.75rem;
        }
        
        .categories-panel,
        .comparison-chart,
        .quick-actions {
            padding: 1rem;
        }
        
        .chart-bars {
            gap: 5px;
            padding: 0 10px;
        }
        
        .actions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Панель управления -->
    <div class="schedule-controls">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h6 class="mb-2">Легенда:</h6>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #d1e7dd;"></span>
                    <span>План</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #d1ecf1;"></span>
                    <span>Факт</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #fff3cd;"></span>
                    <span>Текущее время</span>
                </div>
            </div>
            <div>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-calendar-week"></i></span>
                    <input type="week" class="form-control" id="weekPicker" value="{{ current_week }}">
                    <button class="btn btn-outline-secondary" type="button" id="prevWeekBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="nextWeekBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="currentWeekBtn">
                        Сегодня
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Основной контент -->
    <div class="main-content">
        <!-- Левая часть: таблица расписания -->
        <div class="schedule-section">
            <div class="schedule-container">
                <div class="schedule-header">
                    <h5 class="mb-0">Недельное расписание (шаг 15 минут)</h5>
                    <small class="opacity-75">4:00 - 22:30</small>
                </div>
                
                <div class="table-responsive">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th class="time-column">Время</th>
                                {% for day in days %}
                                <th class="day-column">
                                    <div class="day-header">
                                        {{ day.name }}<br>
                                        <small>{{ day.date }}</small>
                                    </div>
                                    <div class="plan-header">План</div>
                                    <div class="fact-header">Факт</div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <!-- Время будет заполнено JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Правая часть: категории и график -->
        <div class="right-sidebar">
            <!-- Панель категорий -->
            <div class="categories-panel">
                <h5>Категории</h5>
                <div class="categories-list" id="categoriesList">
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-tags" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p class="mt-2">Загрузка категорий...</p>
                    </div>
                </div>
                <button class="btn btn-primary add-category-btn" id="addCategoryBtn">
                    <i class="bi bi-plus-circle me-2"></i>Добавить категорию
                </button>
            </div>
            
            <!-- График сравнения плана и факта -->
            <div class="comparison-chart">
                <h5>Сравнение плана и факта</h5>
                <div class="chart-container">
                    <div class="chart-bars" id="comparisonChart">
                        <!-- График будет создан JavaScript -->
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item-chart">
                            <span class="legend-color-chart" style="background-color: #d1e7dd;"></span>
                            <span>План</span>
                        </div>
                        <div class="legend-item-chart">
                            <span class="legend-color-chart" style="background-color: #d1ecf1;"></span>
                            <span>Факт</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Быстрые действия -->
            <div class="quick-actions">
                <h5>Быстрые действия</h5>
                <div class="actions-grid">
                    <div class="action-btn" data-bs-toggle="modal" data-bs-target="#addEventModal">
                        <i class="bi bi-plus-circle action-icon"></i>
                        <span class="action-text">Добавить событие</span>
                    </div>
                    <div class="action-btn" id="copyWeekBtn">
                        <i class="bi bi-copy action-icon"></i>
                        <span class="action-text">Скопировать неделю</span>
                    </div>
                    <div class="action-btn" id="exportDataBtn">
                        <i class="bi bi-download action-icon"></i>
                        <span class="action-text">Экспорт данных</span>
                    </div>
                    <div class="action-btn" id="importDataBtn">
                        <i class="bi bi-upload action-icon"></i>
                        <span class="action-text">Импорт данных</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить событие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEventForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Тип события</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="eventType" id="typePlan" value="plan" checked>
                                <label class="btn btn-outline-success" for="typePlan">План</label>
                                
                                <input type="radio" class="btn-check" name="eventType" id="typeFact" value="fact">
                                <label class="btn btn-outline-primary" for="typeFact">Факт</label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="categorySelect" class="form-label">Категория</label>
                            <select class="form-select" id="categorySelect" required>
                                <option value="">Выберите категорию</option>
                                <!-- Категории будут заполнены через JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">Дата начала</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Время начала</label>
                            <select class="form-select" id="startTime" required>
                                <!-- Время будет заполнено JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">Дата окончания</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">Время окончания</label>
                            <select class="form-select" id="endTime" required>
                                <!-- Время будет заполнено JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Описание (необязательно)</label>
                        <textarea class="form-control" id="eventDescription" rows="2" placeholder="Дополнительные детали..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить событие</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новая категория</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Название категории</label>
                        <input type="text" class="form-control" id="categoryName" required placeholder="Например: Работа, Учёба, Спорт...">
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">Цвет категории</label>
                        <div class="d-flex flex-wrap gap-2" id="colorPicker">
                            <!-- Цвета будут добавлены JavaScript -->
                        </div>
                        <input type="hidden" id="selectedColor" value="#4361ee" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Описание (необязательно)</label>
                        <textarea class="form-control" id="categoryDescription" rows="2" placeholder="Описание категории..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать категорию</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scheduleBody = document.getElementById('scheduleBody');
    const weekPicker = document.getElementById('weekPicker');
    const currentWeekBtn = document.getElementById('currentWeekBtn');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const copyWeekBtn = document.getElementById('copyWeekBtn');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const categoriesList = document.getElementById('categoriesList');
    const comparisonChart = document.getElementById('comparisonChart');
    
    // Конфигурация времени
    const START_HOUR = 4;
    const END_HOUR = 22.5; // 22:30
    const TIME_SLOT_MINUTES = 15;
    
    let categories = [];
    let events = [];
    
    // Инициализация
    initSchedule();
    loadCategories();
    loadEvents();
    
    // Основные функции для расписания
    function initSchedule() {
        scheduleBody.innerHTML = '';
        
        for (let hour = START_HOUR; hour < END_HOUR; hour += 0.25) {
            const hourInt = Math.floor(hour);
            const minute = (hour - hourInt) * 60;
            
            const timeString = `${hourInt.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const isHourMark = minute === 0;
            
            const row = document.createElement('tr');
            
            if (isHourMark) {
                row.classList.add('hour-marker');
            }
            
            // Проверка текущего времени
            const now = new Date();
            const currentHour = now.getHours() + now.getMinutes() / 60;
            if (Math.abs(currentHour - hour) < 0.125) {
                row.classList.add('current-time');
            }
            
            // Колонка времени
            const timeCell = document.createElement('td');
            timeCell.className = 'time-column';
            timeCell.textContent = timeString;
            row.appendChild(timeCell);
            
            // Колонки для каждого дня
            for (let i = 0; i < 7; i++) {
                const planCell = document.createElement('td');
                planCell.className = 'plan-cell';
                planCell.dataset.time = timeString;
                planCell.dataset.day = i;
                planCell.dataset.type = 'plan';
                planCell.addEventListener('click', handleCellClick);
                
                const factCell = document.createElement('td');
                factCell.className = 'fact-cell';
                factCell.dataset.time = timeString;
                factCell.dataset.day = i;
                factCell.dataset.type = 'fact';
                factCell.addEventListener('click', handleCellClick);
                
                const dayCell = document.createElement('td');
                dayCell.className = 'day-column';
                dayCell.appendChild(planCell);
                dayCell.appendChild(factCell);
                
                row.appendChild(dayCell);
            }
            
            scheduleBody.appendChild(row);
        }
    }
    
    function handleCellClick(event) {
        const cell = event.currentTarget;
        const time = cell.dataset.time;
        const day = parseInt(cell.dataset.day);
        const type = cell.dataset.type;
        
        // Получаем дату из выбранной недели
        const [year, week] = weekPicker.value.split('-W');
        const date = getDateFromWeek(year, week, day);
        
        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
        
        // Устанавливаем тип события
        if (type === 'plan') {
            document.getElementById('typePlan').checked = true;
        } else {
            document.getElementById('typeFact').checked = true;
        }
        
        // Устанавливаем даты
        document.getElementById('startDate').value = date;
        document.getElementById('endDate').value = date;
        
        // Устанавливаем время
        document.getElementById('startTime').value = time;
        
        // Рассчитываем время окончания (+1 час по умолчанию)
        const [hours, minutes] = time.split(':').map(Number);
        let endHour = hours + 1;
        if (endHour >= END_HOUR) endHour = END_HOUR - 0.25;
        const endTime = `${endHour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        document.getElementById('endTime').value = endTime;
        
        modal.show();
    }
    
    function getDateFromWeek(year, week, day) {
        const simple = new Date(year, 0, 1 + (week - 1) * 7 + day);
        const dow = simple.getDay();
        const ISOweekStart = simple;
        
        if (dow <= 4) {
            ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1 + day);
        } else {
            ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay() + day);
        }
        
        return ISOweekStart.toISOString().split('T')[0];
    }
    
    // Функции для загрузки данных
    function loadCategories() {
        console.log('Загрузка категорий...');
        
        const apiPaths = [
            '/api/v1/schedule/categories',
            '/api/v1/categories',
            '/api/my/stats'
        ];
        
        let requestIndex = 0;
        
        function tryNextPath() {
            if (requestIndex >= apiPaths.length) {
                console.log('Все пути API недоступны, используем тестовые данные');
                loadTestCategories();
                return;
            }
            
            const path = apiPaths[requestIndex];
            console.log(`Пробуем путь: ${path}`);
            
            fetch(path)
                .then(response => {
                    console.log(`Ответ от ${path}: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Данные категорий:', data);
                    
                    if (data.status === 'success' && data.categories) {
                        categories = data.categories;
                        updateCategoriesList();
                        updateCategorySelect();
                    } else if (data.categories) {
                        categories = data.categories;
                        updateCategoriesList();
                        updateCategorySelect();
                    } else {
                        console.warn('Неожиданный формат данных:', data);
                        loadTestCategories();
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при запросе ${path}:`, error);
                    requestIndex++;
                    tryNextPath();
                });
        }
        
        tryNextPath();
    }
    
    function updateCategoriesList() {
        categoriesList.innerHTML = '';
        
        if (categories.length === 0) {
            categoriesList.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-tags" style="font-size: 2rem; opacity: 0.3;"></i>
                    <p class="mt-2">Нет категорий</p>
                    <small>Создайте свою первую категорию</small>
                </div>
            `;
            return;
        }
        
        // Подсчитываем время по категориям
        const categoryStats = {};
        events.forEach(event => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                const duration = (end - start) / (1000 * 60 * 60); // Часы
                
                const categoryName = event.category_name || 'Без категории';
                if (!categoryStats[categoryName]) {
                    categoryStats[categoryName] = 0;
                }
                categoryStats[categoryName] += duration;
            } catch (error) {
                console.error('Ошибка при подсчете времени категории:', error);
            }
        });
        
        // Создаем элементы категорий
        categories.forEach(category => {
            const hours = categoryStats[category.name] || 0;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-item';
            categoryDiv.style.borderLeftColor = category.color || '#6c757d';
            
            categoryDiv.innerHTML = `
                <div class="category-color" style="background-color: ${category.color || '#6c757d'}"></div>
                <div class="category-info">
                    <div class="category-name">${category.name}</div>
                    <div class="category-time">${Math.round(hours)} часов</div>
                </div>
                <button class="btn btn-sm btn-outline-secondary edit-category-btn" data-id="${category.id}">
                    <i class="bi bi-pencil"></i>
                </button>
            `;
            
            categoriesList.appendChild(categoryDiv);
        });
    }
    
    function updateCategorySelect() {
        const categorySelect = document.getElementById('categorySelect');
        categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (category.color) {
                option.dataset.color = category.color;
            }
            categorySelect.appendChild(option);
        });
    }
    
    function loadEvents() {
        console.log('Загрузка событий...');
        
        const [year, week] = weekPicker.value.split('-W');
        const apiPaths = [
            `/api/v1/schedule/week/${year}-W${week}`,
            `/api/v1/events/week/${year}-W${week}`,
            '/api/my/events'
        ];
        
        let requestIndex = 0;
        
        function tryNextPath() {
            if (requestIndex >= apiPaths.length) {
                console.log('Все пути API недоступны, используем тестовые события');
                loadTestEvents();
                return;
            }
            
            const path = apiPaths[requestIndex];
            console.log(`Загрузка событий по пути: ${path}`);
            
            fetch(path)
                .then(response => {
                    console.log(`Ответ событий от ${path}: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Данные событий:', data);
                    
                    if (data.status === 'success' && data.events) {
                        events = data.events;
                        renderEvents();
                        updateCategoriesList();
                        updateComparisonChart();
                    } else if (Array.isArray(data)) {
                        events = data.map(event => ({
                            ...event,
                            category_name: event.category,
                            category_color: event.category_color
                        }));
                        renderEvents();
                        updateCategoriesList();
                        updateComparisonChart();
                    } else {
                        console.warn('Неожиданный формат данных событий:', data);
                        loadTestEvents();
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при загрузке событий из ${path}:`, error);
                    requestIndex++;
                    tryNextPath();
                });
        }
        
        tryNextPath();
    }
    
    function renderEvents() {
        console.log('Отрисовка событий, количество:', events.length);
        
        document.querySelectorAll('.plan-event, .fact-event').forEach(el => el.remove());
        
        if (events.length === 0) {
            console.log('Нет событий для отображения');
            return;
        }
        
        events.forEach((event, index) => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                
                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;
                
                const duration = (endHour - startHour) * 4;
                const startSlot = Math.round((startHour - START_HOUR) * 4);
                
                if (startSlot < 0 || startSlot >= scheduleBody.children.length) {
                    console.warn(`Событие вне диапазона времени: ${startHour}:00`);
                    return;
                }
                
                const dayOfWeek = start.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const row = scheduleBody.children[startSlot];
                if (!row) return;
                
                const cell = row.children[adjustedDay + 1];
                if (!cell) return;
                
                const targetCell = event.type === 'plan' ? 
                    cell.querySelector('.plan-cell') : 
                    cell.querySelector('.fact-cell');
                
                if (!targetCell) return;
                
                const eventDiv = document.createElement('div');
                eventDiv.className = event.type === 'plan' ? 'plan-event' : 'fact-event';
                eventDiv.textContent = event.category_name || event.category?.name || 'Без категории';
                
                const startTimeStr = start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTimeStr = end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                eventDiv.title = `${event.category_name || 'Без категории'}\n${startTimeStr} - ${endTimeStr}`;
                
                eventDiv.style.borderLeftColor = event.category_color || 
                                                event.category?.color || 
                                                (event.type === 'plan' ? '#198754' : '#0d6efd');
                
                if (duration > 1) {
                    eventDiv.style.height = `calc(${duration * 40}px - 2px)`;
                    eventDiv.style.position = 'absolute';
                    eventDiv.style.top = '0';
                    eventDiv.style.left = '2px';
                    eventDiv.style.right = '2px';
                    eventDiv.style.zIndex = '1';
                }
                
                targetCell.appendChild(eventDiv);
                
            } catch (error) {
                console.error(`Ошибка при отрисовке события ${index}:`, error, event);
            }
        });
    }
    
    // Функция для создания графика сравнения
    function updateComparisonChart() {
        comparisonChart.innerHTML = '';
        
        const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        const dayStats = dayNames.map(() => ({ plan: 0, fact: 0 }));
        
        // Собираем статистику по дням
        events.forEach(event => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                const duration = (end - start) / (1000 * 60 * 60); // Часы
                
                const dayIndex = start.getDay();
                const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                if (event.type === 'plan') {
                    dayStats[adjustedIndex].plan += duration;
                } else {
                    dayStats[adjustedIndex].fact += duration;
                }
            } catch (error) {
                console.error('Ошибка при обработке события для графика:', error);
            }
        });
        
        // Находим максимальное значение для масштабирования
        const maxHours = Math.max(...dayStats.map(day => Math.max(day.plan, day.fact)), 1);
        
        // Создаем график
        dayNames.forEach((dayName, index) => {
            const planHours = dayStats[index].plan;
            const factHours = dayStats[index].fact;
            
            const planHeight = Math.round((planHours / maxHours) * 100);
            const factHeight = Math.round((factHours / maxHours) * 100);
            
            const dayDiv = document.createElement('div');
            dayDiv.className = 'chart-day';
            
            dayDiv.innerHTML = `
                <div class="bar-container">
                    <div class="plan-bar" style="height: ${planHeight}%;" 
                         title="План: ${Math.round(planHours)}ч">
                        ${planHours > 0 ? `<span class="bar-value">${Math.round(planHours)}ч</span>` : ''}
                    </div>
                    <div class="fact-bar" style="height: ${factHeight}%;" 
                         title="Факт: ${Math.round(factHours)}ч">
                        ${factHours > 0 ? `<span class="bar-value">${Math.round(factHours)}ч</span>` : ''}
                    </div>
                </div>
                <div class="day-label">${dayName}</div>
            `;
            
            comparisonChart.appendChild(dayDiv);
        });
    }
    
    // Тестовые данные (если API недоступно)
    function loadTestCategories() {
        console.log('Загрузка тестовых категорий');
        
        categories = [
            { id: 1, name: 'Работа', color: '#4361ee', description: 'Рабочие задачи' },
            { id: 2, name: 'Учёба', color: '#7209b7', description: 'Обучение и образование' },
            { id: 3, name: 'Спорт', color: '#f72585', description: 'Физическая активность' },
            { id: 4, name: 'Отдых', color: '#4cc9f0', description: 'Время для отдыха' },
            { id: 5, name: 'Семья', color: '#2a9d8f', description: 'Время с семьей' }
        ];
        
        updateCategoriesList();
        updateCategorySelect();
    }
    
    function loadTestEvents() {
        console.log('Загрузка тестовых событий');
        
        const [year, week] = weekPicker.value.split('-W');
        const startDate = getDateFromWeek(year, week, 0); // Понедельник
        
        events = [
            {
                id: 1,
                type: 'plan',
                category_name: 'Работа',
                category_color: '#4361ee',
                start_time: new Date(new Date(startDate).setHours(9, 0, 0)).toISOString(),
                end_time: new Date(new Date(startDate).setHours(11, 0, 0)).toISOString(),
                description: 'Совещание с командой'
            },
            {
                id: 2,
                type: 'fact',
                category_name: 'Работа',
                category_color: '#4361ee',
                start_time: new Date(new Date(startDate).setHours(9, 30, 0)).toISOString(),
                end_time: new Date(new Date(startDate).setHours(11, 15, 0)).toISOString(),
                description: 'Совещание с командой'
            },
            {
                id: 3,
                type: 'plan',
                category_name: 'Учёба',
                category_color: '#7209b7',
                start_time: new Date(new Date(startDate).setHours(18, 0, 0)).toISOString(),
                end_time: new Date(new Date(startDate).setHours(20, 0, 0)).toISOString(),
                description: 'Изучение нового фреймворка'
            }
        ];
        
        renderEvents();
        updateCategoriesList();
        updateComparisonChart();
    }
    
    // Инициализация цветов для выбора
    function initColorPicker() {
        const colors = [
            '#4361ee', '#3a0ca3', '#7209b7', '#f72585',
            '#4cc9f0', '#2a9d8f', '#e9c46a', '#f4a261',
            '#e76f51', '#264653', '#2a9d8f', '#e9c46a'
        ];
        
        colors.forEach(color => {
            const colorBtn = document.createElement('button');
            colorBtn.type = 'button';
            colorBtn.className = 'btn btn-sm rounded-circle';
            colorBtn.style.width = '30px';
            colorBtn.style.height = '30px';
            colorBtn.style.backgroundColor = color;
            colorBtn.style.border = '2px solid #fff';
            colorBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            colorBtn.title = color;
            
            colorBtn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('selectedColor').value = color;
                
                // Убираем выделение со всех кнопок
                document.querySelectorAll('#colorPicker button').forEach(btn => {
                    btn.style.border = '2px solid #fff';
                });
                
                // Добавляем выделение выбранной кнопке
                this.style.border = '2px solid #000';
            });
            
            colorPicker.appendChild(colorBtn);
        });
    }
    
    // Инициализация выбора времени
    function initTimeSelects() {
        const startTimeSelect = document.getElementById('startTime');
        const endTimeSelect = document.getElementById('endTime');
        
        for (let hour = 4; hour <= 22; hour++) {
            for (let minute = 0; minute < 60; minute += 15) {
                const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                
                const option1 = document.createElement('option');
                option1.value = time;
                option1.textContent = time;
                startTimeSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = time;
                option2.textContent = time;
                endTimeSelect.appendChild(option2);
            }
        }
    }
    
    // Обработчики событий
    weekPicker.addEventListener('change', loadEvents);
    
    currentWeekBtn.addEventListener('click', function() {
        const today = new Date();
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        const currentWeek = `${today.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
        
        weekPicker.value = currentWeek;
        loadEvents();
    });
    
    prevWeekBtn.addEventListener('click', function() {
        const [year, week] = weekPicker.value.split('-W');
        let newWeek = parseInt(week) - 1;
        let newYear = parseInt(year);
        
        if (newWeek < 1) {
            newYear--;
            newWeek = 52;
        }
        
        weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        loadEvents();
    });
    
    nextWeekBtn.addEventListener('click', function() {
        const [year, week] = weekPicker.value.split('-W');
        let newWeek = parseInt(week) + 1;
        let newYear = parseInt(year);
        
        if (newWeek > 52) {
            newYear++;
            newWeek = 1;
        }
        
        weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        loadEvents();
    });
    
    copyWeekBtn.addEventListener('click', function() {
        if (confirm('Скопировать план текущей недели на следующую неделю?')) {
            alert('Функция копирования недели временно недоступна');
        }
    });
    
    addCategoryBtn.addEventListener('click', function() {
        initColorPicker(); // Инициализируем палитру цветов
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    });
    
    exportDataBtn.addEventListener('click', function() {
        alert('Функция экспорта данных временно недоступна');
    });
    
    importDataBtn.addEventListener('click', function() {
        alert('Функция импорта данных временно недоступна');
    });
    
    // Инициализация модального окна
    document.getElementById('addEventForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Событие успешно добавлено!');
        bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
    });
    
    document.getElementById('categoryForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Категория успешно создана!');
        bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
    });
    
    console.log('Страница расписания загружена');
});
</script>
{% endblock %}
